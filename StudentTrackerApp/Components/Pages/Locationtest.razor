@page "/location"
@inject IJSRuntime JS
@rendermode InteractiveServer

<h3>Location Check-In System</h3>

<div class="d-flex gap-2 mt-3">
    <button class="btn btn-success"
            @onclick="CheckIn"
            disabled="@isCheckedIn">
        Check In
    </button>

    <button class="btn btn-danger"
            @onclick="CheckOut"
            disabled="@(isLoading || !isCheckedIn)">
        Check Out
    </button>
</div>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <p class="text-danger mt-3">Error: @errorMessage</p>
}
else if (isLoading)
{
    <p class="text-info mt-3">Fetching location...</p>
}
else if (latitude.HasValue && longitude.HasValue)
{
    <div class="mt-3">
        <p><strong>Status:</strong> @(isCheckedIn ? "Checked In" : "Checked Out")</p>
        <p><strong>Latitude:</strong> @latitude</p>
        <p><strong>Longitude:</strong> @longitude</p>
        <p><strong>Timestamp:</strong> @timestamp?.ToString("yyyy-MM-dd HH:mm:ss")</p>
    </div>
}
else
{
    <p class="mt-3">No check-in data yet.</p>
}

@code {
    private double? latitude;
    private double? longitude;
    private string? errorMessage;
    private bool isLoading = false;
    private bool isCheckedIn = false;
    private DateTime? timestamp;

    private async Task CheckIn()
    {
        await GetLocation();
        if (latitude.HasValue && longitude.HasValue)
        {
            isCheckedIn = true;
        }
    }

    private async Task CheckOut()
    {
        await GetLocation();
        if (latitude.HasValue && longitude.HasValue)
        {
            isCheckedIn = false;
        }
    }

    private async Task GetLocation()
    {
        try
        {
            isLoading = true;
            errorMessage = null;
            latitude = longitude = null;
            timestamp = null;
            StateHasChanged();

            var result = await JS.InvokeAsync<LocationData>("blazorGetLocation");
            latitude = result.Latitude;
            longitude = result.Longitude;
            timestamp = DateTime.Now;
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private class LocationData
    {
        public double Latitude { get; set; }
        public double Longitude { get; set; }
    }
}
