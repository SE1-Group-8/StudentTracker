@page "/login"
@rendermode InteractiveServer
@using Repositories
@using Services
@using Models
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@inject IUserRepository userrepo
@inject UserSession session
@inject NavigationManager NavManager
@inject ProtectedSessionStorage ProtectedSessionStore
<PageTitle>Login</PageTitle>

<h1>Login</h1>

<EditForm Model="@loginModel" OnValidSubmit="HandleLogin" FormName="LoginForm">
    <DataAnnotationsValidator />
    <ValidationSummary />
    <InputText @bind-Value="loginModel.Email" placeholder="Email" />
    <InputText @bind-Value="loginModel.Password" placeholder="Password" type="password" />
    <button type="submit">Login</button>
</EditForm>
@if (!string.IsNullOrEmpty(Error))
{
    <p class="text-danger">@Error</p>
}
<div style="margin-top: 1rem;">
    <button @onclick="GoToCreateAccount">Create Account</button>
</div>



@code
{
    private LoginModel loginModel = new();
    private string Error { get; set; }

    private async Task HandleLogin()
    {
        var email = loginModel.Email?.Trim().ToLowerInvariant();
        var password = loginModel.Password?.Trim();
        var user = await userrepo.GetUserByEmailAndPasswordAsync(email, password);
        if (user == null)
        {
            Error = $"Invalid email or password";
            return;
        }

        session.Id = user.Id;
        session.Email = user.Email;
        session.UserType = user.UserType;
        session.FirstName = user.FirstName;
        session.LastName = user.LastName;

        await ProtectedSessionStore.SetAsync("UserId", user.Id);

        NavManager.NavigateTo("/");
    }

    private void GoToCreateAccount()
    {
        NavManager.NavigateTo("/createaccount");
    }

    public class LoginModel
    {
        public string Email { get; set; }
        public string Password { get; set; }
    }
}
