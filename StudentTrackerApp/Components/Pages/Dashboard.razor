@page "/userDashboard"
@attribute [StreamRendering]
@using Repositories
@using Models
@inject IUserRepository UserRepo
@inject IStudentTeacherRepository StudentTeacherRepo
@rendermode InteractiveServer

<PageTitle>Dashboard</PageTitle>

<div>
    <h1> Welcome @user.FirstName @user.LastName </h1>
</div>
@*
<div>
    <table class="Table">
        <thead>
            <tr>Notification</tr>
        </thead>
        <tbody>
            @foreach(string noti in user.Notifications){
                <tr>
                    <td>@noti</td>
                </tr>
            }
            
        </tbody>
    </table>
</div>
*@
<div>
    <table class="Table">
        <thead>
            <tr>
                <th>First Name</th>
                <th>Last Name</th>
                <th>E-mail</th>
                @if(!isStudent){
                    <th>Location</th>
                    <th>Check In Time</th>
                    <th>Check Out Time</th>
                }
            </tr>
        </thead>
        <tbody>
            @foreach(var person in connections){
                <tr>
                    <td>@person.FirstName</td>
                    <td>@person.LastName</td>
                    <td>@person.Email</td>
                    @if(person is Student student){
                        <td>@student.Location</td>
                        <td>@student.CheckInTime</td>
                        <td>@student.CheckOutTime</td>
                    }
                </tr>
            }
        </tbody>
    </table>
</div>


@if(isStudent){
    <div>
        <h3>Location</h3>
        @if(!locationDisabled){
            <input type="text" @bind="locationInput" placeholder="Enter Location..." class="form-control"/>
            <btn class="btn btn-primary" @onclick="() => SetLocation(locationInput)">Enter Location</btn>
        }
        <p>@studentUser.Location</p>

        <h3>Check-In/Out</h3>
        @if(!checkInDisabled){
            <btn class="btn btn-secondary" @onclick="CheckIn">Check-In</btn>
        }
        @if(!checkOutDisabled){
        <btn class="btn btn-danger" @onclick="CheckOut">Check-Out</btn>
        }
        <table class="Table">
            <thead>
                <tr>
                    <th>Check-In Time</th>
                    <th>Check-Out Time</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>@studentUser.CheckInTime</td>
                    <td>@studentUser.CheckOutTime</td>
                </tr>
            </tbody>
        </table>
    </div>
    } else{
    <div>
        <h3>Notification</h3>
        <input type="text" @bind="notiString" placeholder="Enter Notification..." class="form-control"/>
        <btn class="btn btn-primary" @onclick="() => PushNotification(notiString)">Push Notification</btn>
    </div>
    }

@code{
    private User user = new User();
    private bool isStudent = false;
    private List<User> connections = new List<User>();
    private string locationInput;
    private string notiString;
    private Student? studentUser;
    private bool locationDisabled = false;
    private bool checkInDisabled = false;
    private bool checkOutDisabled = true;

    private int USERID = 2;

    private void SetLocation(string inLocation){
        studentUser.Location = inLocation;
        locationDisabled = true;
    }

    private void CheckIn(){
        studentUser.CheckInTime = DateTime.Now.ToString("HH:mm");
        checkInDisabled = true;
        checkOutDisabled = false;
    }

    private void CheckOut(){
        studentUser.CheckOutTime = DateTime.Now.ToString("HH:mm");
        checkInDisabled = false;
        checkOutDisabled = true;
        locationDisabled = false;
    }

    private void PushNotification(string inMsg){
        // Do smth here
    }

    protected override async Task OnInitializedAsync(){
        user = await UserRepo.ReadUserAsync(USERID);
        List<int> connectionIDs = new List<int>();
        
        if(user.UserType.ToLower() == "student"){
            isStudent = true;
            studentUser = new Student(user);
            connectionIDs = await StudentTeacherRepo.GetTeachersByStudentIdAsync(studentUser.Id);
        }
        else { 
            connectionIDs = await StudentTeacherRepo.GetStudentsByTeacherIdAsync(user.Id);
        }

        foreach(int person in connectionIDs){
            connections.Add(await UserRepo.ReadUserAsync(person));
        }
    }
}
