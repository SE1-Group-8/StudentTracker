@page "/"
@attribute [StreamRendering]
@using Repositories
@using Models
@using Services
@inject IUserRepository UserRepo
@inject IStudentTeacherRepository StudentTeacherRepo
@inject IJSRuntime JS
@inject UserSession Session
@inject NavigationManager NavMan
@inject DbCheckInRepository CheckInRepo
@rendermode InteractiveServer

<PageTitle>Dashboard</PageTitle>

<div>
    <h1>Welcome @user.FirstName @user.LastName</h1>
</div>

<div class="table-responsive mt-3">
    @if (!IsStudent)
    {
        <h3>Students Assigned</h3>
    }
    else
    {
        <h3>Teachers Assigned</h3>
    }
    <table class="table table-striped align-middle text-center shadow-sm rounded-3 overflow-hidden">
        <thead class="table-dark">
            <tr>
                <th>First Name</th>
                <th>Last Name</th>
                <th>E-mail</th>
                @if (!IsStudent)
                {
                    <th>Logs</th>
                }
            </tr>
        </thead>
        <tbody>
            @foreach (var person in connections)
            {
                <tr>
                    <td>@person.FirstName</td>
                    <td>@person.LastName</td>
                    <td>
                        <a href="mailto:@person.Email" class="text-decoration-none">@person.Email</a>
                    </td>

                    @if (!IsStudent)
                    {
                        <td>
                            <a href="/student-checkin/@person.Id">
                                View Logs
                            </a>
                        </td>
                    }
                </tr>
            }
        </tbody>
    </table>
</div>

<hr />

@if (IsStudent)
{
    <!-- NOTES TEXTAREA -->
    <div class="mt-3">
        <textarea class="form-control"
                  @bind="CheckoutNotes"
                  placeholder="Enter notes before checking out..."
                  rows="3"></textarea>
    </div>

    <div class="d-flex gap-2 mt-3">
        <btn class="btn btn-success" @onclick="CheckInAsync" disabled="@(!IsLoggedIn || IsCheckedIn)">Check In</btn>
        <btn class="btn btn-danger" @onclick="CheckOutAsync" disabled="@(!IsLoggedIn || isLoading || !IsCheckedIn)">Check Out</btn>
    </div>

    @if (!IsLoggedIn)
    {
        <p class="text-warning mt-3">Please sign in to use the check-in system.</p>
    }
    else if (!string.IsNullOrEmpty(errorMessage))
    {
        <p class="text-danger mt-3">Error: @errorMessage</p>
    }
    else if (isLoading)
    {
        <p class="text-info mt-3">Fetching location...</p>
    }
    else if (Latitude.HasValue && Longitude.HasValue)
    {
        <div class="mt-3">
            <p><strong>Status:</strong> @(IsCheckedIn ? "Checked In" : "Checked Out")</p>
            <p><strong>Latitude:</strong> @Latitude</p>
            <p><strong>Longitude:</strong> @Longitude</p>
            <p><strong>TimeStamp:</strong> @TimeStamp?.ToString("yyyy-MM-dd HH:mm:ss")</p>
        </div>
    }
    else
    {
        <p class="mt-3">No check-in data yet.</p>
    }
}
else
{
    <h3>Notification</h3>
    <div>
        <input type="text" @bind="notiString" placeholder="Enter Notification..." class="form-control" />
        <btn class="btn btn-primary" @onclick="() => PushNotification(notiString)">Push Notification</btn>
    </div>
}

@code {
    private User user = new User();
    private List<User> connections = new();
    private string notiString = string.Empty;
    private bool IsLoggedIn => Session != null && Session.Id != 0;
    private bool IsStudent;
    private Student? studentUser;

    private double? Latitude;
    private double? Longitude;
    private bool IsCheckedIn = false;
    private string? errorMessage;
    private DateTime? TimeStamp;
    private bool isLoading = false;

    private string CheckoutNotes = string.Empty;

    private class LocationData
    {
        public double Latitude { get; set; }
        public double Longitude { get; set; }
    }

    public record GeolocationCoordinates(double Latitude, double Longitude);

    void PushNotification(string we)
    {
    }

    private async Task CheckInAsync()
    {
        if (!IsLoggedIn)
        {
            return;
        }

        var existing = await CheckInRepo.GetActiveCheckInAsync(Session.Id);
        if (existing != null && existing.CheckOutTime == null)
        {
            errorMessage = "You are already checked in.";
            IsCheckedIn = true;
            return;
        }

        await GetLocationAsync();
        if (Latitude.HasValue && Longitude.HasValue)
        {
            var log = new CheckInLog
            {
                UserId = Session.Id,
                CheckInLatitude = Latitude.Value,
                CheckInLongitude = Longitude.Value,
                CheckInTime = DateTime.Now,
                WithinRange = true
            };

            await CheckInRepo.CreateCheckInAsync(log);

            IsCheckedIn = true;
            TimeStamp = log.CheckInTime;
        }
    }

    private async Task CheckOutAsync()
    {
        if (!IsLoggedIn)
        {
            return;
        }

        await GetLocationAsync();
        if (Latitude.HasValue && Longitude.HasValue)
        {
            var log = await CheckInRepo.GetActiveCheckInAsync(Session.Id);
            if (log != null && log.CheckOutTime == null)
            {
                log.CheckOutLatitude = Latitude.Value;
                log.CheckOutLongitude = Longitude.Value;
                log.CheckOutTime = DateTime.Now;
                log.WithinRange = IsWithinFiveHundredFeet(
                    log.CheckInLatitude, log.CheckInLongitude,
                    log.CheckOutLatitude.Value, log.CheckOutLongitude.Value);

                // Save notes
                log.Notes = CheckoutNotes;

                await CheckInRepo.UpdateCheckOutAsync(log);

                // Reset notes after saving
                CheckoutNotes = string.Empty;

                IsCheckedIn = false;
            }
            else
            {
                errorMessage = "No active check-in found.";
            }
        }
    }

    private async Task GetLocationAsync()
    {
        try
        {
            isLoading = true;
            errorMessage = null;
            StateHasChanged();

            var result = await JS.InvokeAsync<LocationData>("blazorGetLocation");
            Latitude = result.Latitude;
            Longitude = result.Longitude;
            TimeStamp = DateTime.Now;
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private bool IsWithinFiveHundredFeet(double lat1, double lon1, double lat2, double lon2)
    {
        double R = 20902000; // Earth radius in feet
        double dLat = (lat2 - lat1) * Math.PI / 180;
        double dLon = (lon2 - lon1) * Math.PI / 180;

        lat1 = lat1 * Math.PI / 180;
        lat2 = lat2 * Math.PI / 180;

        double a = Math.Pow(Math.Sin(dLat / 2), 2) +
                   Math.Pow(Math.Sin(dLon / 2), 2) *
                   Math.Cos(lat1) * Math.Cos(lat2);

        double c = 2 * Math.Asin(Math.Sqrt(a));
        double distance = R * c;

        return distance <= 500.0;
    }

    protected override async Task OnInitializedAsync()
    {
        if (IsLoggedIn)
        {
            if (Session.UserType == "Student")
            {
                IsStudent = true;
            }
            else
            {
                IsStudent = false;
            }

            user = await UserRepo.ReadUserAsync(Session.Id);

            List<int> connectionIDs = new List<int>();

            if (IsStudent)
            {
                var activeCheckIn = await CheckInRepo.GetActiveCheckInAsync(user.Id);

                if (activeCheckIn != null && activeCheckIn.CheckOutTime == null)
                {
                    IsCheckedIn = true;
                    Latitude = activeCheckIn.CheckInLatitude;
                    Longitude = activeCheckIn.CheckInLongitude;
                    TimeStamp = activeCheckIn.CheckInTime;
                }

                studentUser = new Student(user);
                connectionIDs = await StudentTeacherRepo.GetTeachersByStudentIdAsync(studentUser.Id);
            }
            else
            {
                connectionIDs = await StudentTeacherRepo.GetStudentsByTeacherIdAsync(user.Id);
            }

            foreach (int personId in connectionIDs)
            {
                connections.Add(await UserRepo.ReadUserAsync(personId));
            }
        }
        else
        {
            NavMan.NavigateTo("/login");
        }
    }
}
